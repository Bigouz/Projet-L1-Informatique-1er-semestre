<!doctype html>
<html>

<head>
    <title>Sing On Light - Jouer</title>
    <link rel="icon" href="static/images/favicon.ico">
</head>

<body>
    <div class="parent">
        <div class="div1">
            <div class="div1a">
                <a class="indexBTN" href="/">Menu Principal</a><br>
                <a class="playBTN" id="currentBTN" href="/Mode.html">Jouer</a><br>
                <a class="calibrationBTN" href="/calibration.html">Calibration</a><br>
                <a class="dataBTN" href="/data.html">DonnÃ©es</a><br>
                <a class="creationBTN" href="/creation_rythme.html">CrÃ©er son propre rythme!</a><br>
                <a href="https://github.com/Bigouz/Projet-L1-Informatique-1er-semestre" target="_blank"
                    class="github">GitHub</a>

            </div>
        </div>
        <div class="div2">
            <h1>Sing On Light - Jouer</h1>
            <div class="text">
                <p>Lorsque vous appuyez sur "Jouer", la partie commencera <strong>immÃ©diatement</strong>.
                    <br>Quand la LED s'allume, faites un <strong>bruit continu</strong> (chanter, siffler, etc.).
                    <br>
                <div class="container" style="min-width: 640px;">
                    <h2>ParamÃ¨tres de la partie</h2>
                    </br>Choisissez vos <strong>paramÃ¨tres</strong> de jeu ci-dessous :
                    <br><br>

                    <div>
                        <label for="rythme">Jouer avec <strong>votre rythme</strong> ? </label>
                        <input type="checkbox" name="rythme" id="rythme" onchange="jouer_avec_rythme()"
                            style="vertical-align:middle;"><br>
                    </div>

                    <label for="dureeIntervalle">DurÃ©e d'<strong>intervalles</strong> (en secondes) : </label>
                    <input type="number" name="dureeIntervalle" id="dureeIntervalle" value="{{dureeIntervalle}}" max="2"
                        min="0.1" step="0.1" onchange="change_value(this);temps_total()"><br>

                    <label for="dureePartie">DurÃ©e de la <strong>partie</strong> (en intervalles) : </label>
                    <input type="number" name="dureePartie" id="dureePartie" value="{{dureePartie}}" max="120" min="5"
                        onchange="this.value=this.value.replace(/[^0-9]/g,''); if(this.value<5)this.value=5; if(this.value>120)this.value=120;temps_total()"><br><br>

                    <br><br>
                    <span id="temps_total"> </span><br>
                    <button id="start" class="start"
                        onclick="this.disabled = true;save_param();document.getElementById('result').innerText = ''; "><strong>Jouer</strong></button>
                    <p id="winstreak">ðŸ”¥ðŸ”¥ðŸ”¥ <strong>Winstreak</strong>: {{winstreak}} ðŸ”¥ðŸ”¥ðŸ”¥ </p>
                </div>

                
                <br><br>
                <p style="color: lime;" id="result">{{message}}</p>
                </p>
                <br><br>
                <p id="temps"></p>
                <span id="longueur_rythme" style="opacity: 0;">{{rythme}}</span>

                <script>
                    function jouer_avec_rythme() {
                        // appelÃ© quand l'etat de la case du rythme personnalisÃ© est changÃ©
                        if (document.getElementById("rythme").checked) {
                            document.getElementById("dureePartie").disabled = true; // desactivation de l'input de duree de la partie en intervalles 
                            document.getElementById("dureePartie").value = parseInt(document.getElementById("longueur_rythme").innerText); // changement de la valeur selon la longueur du rythme
                            temps_total(); // calcul du temps total
                        } else {
                            document.getElementById("dureePartie").disabled = false; // reactivation de l'input de duree de la partie en intervalles
                        }
                    }


                    function change_value(t) {
                        // change la valeur de dureeIntervalles si la valeur est mauvaise (en dehors du max, min, etc)
                        t.value = t.value.replace(/,/g, '.').replace(/[^0-9.]/g, '');
                        let v = parseFloat(t.value);
                        if (isNaN(v)) v = 0.1;
                        if (v < 0.1) v = 0.1;
                        if (v > 2.0) v = 2.0;
                        // arrondi au pas de 0.1
                        v = Math.round(v * 10) / 10;
                        t.value = v.toFixed(1);
                    }


                    function temps_total() {
                        //calcul du temps total
                        let temps = Math.round(document.getElementById("dureePartie").value * document.getElementById("dureeIntervalle").value);
                        document.getElementById("temps_total").innerHTML = "Temps total de la partie : " + temps + " secondes";
                        return temps;
                    }
                    temps_total()

                    const delay = ms => new Promise(res => setTimeout(res, ms));
                    async function save_param() {
                        // sauvegarde les paramÃ¨tres et lance la partie
                        
                        // delai de 3 secondes avant le debut de la partie
                        document.getElementById("temps").innerText = "La partie commence dans 3 secondes.";
                        await delay(1000);
                        document.getElementById("temps").innerText = "La partie commence dans 2 secondes.";
                        await delay(1000);
                        document.getElementById("temps").innerText = "La partie commence dans 1 secondes.";
                        await delay(1000);
                        document.getElementById("temps").innerText = "";

                        const dureeIntervalle = parseFloat(document.getElementById('dureeIntervalle').value);
                        const dureePartie = parseInt(document.getElementById('dureePartie').value);

                        // lancement de la partie
                        const response = await fetch('/run_play', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ "dureeIntervalle": dureeIntervalle, "dureePartie": dureePartie, "isRythme": document.getElementById("rythme").checked ? 1 : 0 })
                        });
                        const data = await response.json();
                        document.getElementById('result').innerText = data["message"];
                        document.getElementById('result').style.color = data["message"].includes("gagnÃ©") ? "lime" : "red";
                        document.getElementById('winstreak').innerText = "ðŸ”¥ðŸ”¥ðŸ”¥ Winstreak: " + data["winstreak"] + " ðŸ”¥ðŸ”¥ðŸ”¥";


                        document.getElementById('start').disabled = false;
                    }
                </script>
            </div>
        </div>
    </div>
    <link rel="stylesheet" href="static/css/style.css">
</body>

</html>


